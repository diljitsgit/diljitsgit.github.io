---
import fs from "fs";
import matter from "gray-matter";
import path from "path";
import BlogPostCard from "../components/BlogPostCard.tsx";
import Footer from "../components/Footer.tsx";
import Navbar from "../components/Navbar.tsx";

import "../styles/global.css";

interface BlogFrontMatter {
    title: string;
    date: string;
    tags?: string[];
}

interface BlogPost {
    slug: string;
    frontmatter: BlogFrontMatter;
    excerpt: string;
    readingTime: string;
}

const blogDir = path.resolve("./src/content/blog");
const files = fs.readdirSync(blogDir).filter((f) => f.endsWith(".mdx"));

function calcReadingTime(content: string) {
    const words = content.split(/\s+/).length;
    const minutes = Math.ceil(words / 200); // 200 wpm avg
    return `${minutes} min read`;
}

const posts: BlogPost[] = files
    .map((file) => {
        const raw = fs.readFileSync(path.join(blogDir, file), "utf-8");
        const { data, content } = matter(raw);
        const excerpt =
            content
                .split("\n")
                .find((line) => line.trim() !== "")
                ?.slice(0, 150) ?? "";
        const readingTime = calcReadingTime(content);

        return {
            slug: file.replace(/\.mdx$/, ""),
            frontmatter: data as BlogFrontMatter,
            excerpt,
            readingTime,
        };
    })
    .sort(
        (a, b) =>
            new Date(b.frontmatter.date).getTime() -
            new Date(a.frontmatter.date).getTime(),
    );
---

<Navbar />
<main class="p-8 max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">Blog</h1>
    <div class="space-y-6">
        {
            posts.map((post) => (
                <BlogPostCard
                    key={post.slug}
                    slug={post.slug}
                    title={post.frontmatter.title}
                    date={post.frontmatter.date}
                    excerpt={post.excerpt}
                    tags={post.frontmatter.tags}
                    readingTime={post.readingTime}
                />
            ))
        }
    </div>
</main>
<Footer />
